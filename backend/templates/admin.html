<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Admin - Application Approvals</title>

  <link href="../static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/assets/css/fontawesome.css">
  <link rel="stylesheet" href="../static/assets/css/templatemo-scholar.css">

  <style>
    body { font-family: "Poppins", sans-serif; }
    .admin-wrap { margin-top: 130px; margin-bottom: 60px; }
    .status-chip { font-size: 0.85rem; border-radius: 999px; padding: 4px 10px; }
    .status-submitted { background: #ffe8b3; color: #8a5c00; }
    .status-under_review { background: #d6edff; color: #0b5ed7; }
    .status-approved { background: #d1f3dd; color: #0f6b31; }
    .status-rejected { background: #ffd6db; color: #8b1d2c; }
    .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .table td, .table th { vertical-align: middle; }
    .name-link { border: none; background: none; color: #0d6efd; text-decoration: underline; padding: 0; font: inherit; }
    .details-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
    .details-modal.is-open { display: flex; }
    .details-modal-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.5); }
    .details-card { position: relative; width: min(1000px, calc(100vw - 32px)); max-height: calc(100vh - 48px); overflow: auto; border: 1px solid #e4e7ec; border-radius: 12px; padding: 20px; background: #fff; z-index: 1; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
    .detail-list { margin: 0; padding: 0; list-style: none; }
    .detail-list li { padding: 5px 0; border-bottom: 1px dashed #f0f0f0; }
    .req-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; }
    .req-item { display: flex; align-items: center; gap: 8px; }
  </style>
</head>

<body>
  <header class="header-area header-sticky background-header">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <nav class="main-nav">
            <a href="/" class="logo"><h1>Arellano University</h1></a>
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li><a href="/enroll">Online Application</a></li>
              <li class="nav-item dropdown scroll-to-section">
                <a class="nav-link dropdown-toggle admissions-link active" href="/admin" id="admissionsDropdown"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Admin
                </a>

                <div class="dropdown-menu admissions-menu" aria-labelledby="admissionsDropdown">
                  <form action="/admin/logout" method="post" style="margin:0;">
                    <button type="submit" class="dropdown-item" style="color:#fff; text-decoration:none;">Logout</button>
                  </form>
                </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <main class="container admin-wrap">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap" style="gap: 12px;">
      <div>
        <h3 class="mb-1">Application Approval Dashboard</h3>
        <p class="mb-0 text-muted">Review submitted applications and approve or reject them.</p>
      </div>
      <div class="d-flex" style="gap: 10px;">
        <select id="statusFilter" class="form-control">
          <option value="">All statuses</option>
          <option value="submitted">Submitted</option>
          <option value="under_review">Under review</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <select id="strandFilter" class="form-control">
          <option value="">All strands</option>
          <option value="STEM">STEM</option>
          <option value="ABM">ABM</option>
          <option value="HUMSS">HUMSS</option>
          <option value="GAS">GAS</option>
          <option value="TVL">TVL</option>
          <option value="ICT">ICT</option>
          <option value="HE">HE</option>
        </select>
        <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      </div>
    </div>

    <div class="alert alert-info d-none" id="messageBox" role="alert"></div>

    <div class="table-responsive bg-white rounded shadow-sm p-2">
      <table class="table table-striped table-hover mb-0" id="applicationsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Student</th>
            <th>LRN</th>
            <th>Strand</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Documents</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </main>

  <section id="detailsModal" class="details-modal" aria-hidden="true">
    <div class="details-modal-backdrop" data-close-modal="true"></div>
    <div class="details-card shadow-sm" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="d-flex justify-content-between align-items-center flex-wrap" style="gap: 12px;">
        <div>
          <h4 class="mb-1" id="detailsTitle">Applicant Details</h4>
          <p class="mb-0 text-muted" id="detailsSubtitle">Select an applicant to view details.</p>
        </div>
        <div class="action-btns">
          <button class="btn btn-success" id="detailsApproveBtn">Approve</button>
          <button class="btn btn-danger" id="detailsRejectBtn">Reject</button>
          <button class="btn btn-outline-secondary" id="detailsCloseBtn" data-close-modal="true">Close</button>
        </div>
      </div>

      <hr>

      <div class="details-grid mb-4">
        <div>
          <h6>Complete Form Answers</h6>
          <ul class="detail-list" id="completeAnswersList"></ul>
        </div>
        <div>
          <h6>Submitted Requirements</h6>
          <div class="req-grid" id="requirementsChecklist"></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    const tbody = document.querySelector('#applicationsTable tbody');
    const messageBox = document.getElementById('messageBox');
    const statusFilter = document.getElementById('statusFilter');
    const strandFilter = document.getElementById('strandFilter');
    const detailsModal = document.getElementById('detailsModal');
    const detailsSubtitle = document.getElementById('detailsSubtitle');
    const completeAnswersList = document.getElementById('completeAnswersList');
    const requirementsChecklist = document.getElementById('requirementsChecklist');
    const detailsApproveBtn = document.getElementById('detailsApproveBtn');
    const detailsRejectBtn = document.getElementById('detailsRejectBtn');
    const detailsCloseBtn = document.getElementById('detailsCloseBtn');
    const knownRequirements = ['Form 138', 'Good Moral Certificate', 'PSA Birth Certificate', '2x2 Picture'];
    let selectedApplicationId = null;

    function showMessage(text, level = 'info') {
      messageBox.textContent = text;
      messageBox.className = `alert alert-${level}`;
      messageBox.classList.remove('d-none');
    }

    function hideMessage() {
      messageBox.classList.add('d-none');
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function statusChip(status) {
      const safe = escapeHtml(status || 'submitted');
      return `<span class="status-chip status-${safe}">${safe.replace('_', ' ')}</span>`;
    }

    function parseSubmittedRequirements(csv) {
      return String(csv || '')
        .split(',')
        .map(item => item.trim())
        .filter(Boolean);
    }

    function valueOrDash(value) {
      const cleaned = String(value ?? '').trim();
      return cleaned ? cleaned : 'â€”';
    }

    function closeDetailsModal() {
      detailsModal.classList.remove('is-open');
      detailsModal.setAttribute('aria-hidden', 'true');
    }

    async function updateStatus(id, status) {
      hideMessage();
      try {
        const res = await fetch(`/api/applications/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          throw new Error(payload.error || 'Failed to update status.');
        }
        showMessage(`Application #${id} updated to ${status}.`, 'success');
        await loadApplications();
      } catch (err) {
        showMessage(err.message, 'danger');
      }
    }

    function buildActionButtons(item) {
      const buttons = [];
      if (item.status !== 'under_review') {
        buttons.push(`<button class="btn btn-sm btn-outline-primary" data-action="under_review" data-id="${item.id}">Mark Under Review</button>`);
      }
      if (item.status !== 'approved') {
        buttons.push(`<button class="btn btn-sm btn-success" data-action="approved" data-id="${item.id}">Approve</button>`);
      }
      if (item.status !== 'rejected') {
        buttons.push(`<button class="btn btn-sm btn-danger" data-action="rejected" data-id="${item.id}">Reject</button>`);
      }
      return `<div class="action-btns">${buttons.join('')}</div>`;
    }

    function renderRequirementsCheckboxes(credentialsSubmitted) {
      const picked = new Set(parseSubmittedRequirements(credentialsSubmitted));
      requirementsChecklist.innerHTML = knownRequirements.map((name) => {
        const checked = picked.has(name) ? 'checked' : '';
        return `
          <label class="req-item">
            <input type="checkbox" disabled ${checked}>
            <span>${escapeHtml(name)}</span>
          </label>
        `;
      }).join('');
    }

    function renderCompleteAnswers(item) {
      const rows = [
        ['Name', item.fullName],
        ['LRN', item.lrn],
        ['Contact Number', item.contact],
        ['Email Address', item.email],
        ['Present/Home Address', item.address],
        ['Date of Birth', item.dob],
        ['Sex', item.sex],
        ['Nationality', item.nationality],
        ['Strand', item.strand],
        ['TVL Specialization', item.tvlSpec],
        ['JHS Graduated', item.jhsGraduated],
        ['Date of Graduation', item.dateGraduation],
        ['Civil Status', item.guardianCivilStatus],
        ['Parent/Guardian Name', item.guardianName],
        ['Relationship', item.guardianRelationship],
        ['Occupation', item.guardianOccupation],
        ['Tel No.', item.guardianTel],
        ['Cellphone No.', item.guardianContact],
      ];

      completeAnswersList.innerHTML = rows
        .map(([label, value]) => `<li><strong>${escapeHtml(label)}:</strong> ${escapeHtml(valueOrDash(value))}</li>`)
        .join('');
    }

    async function loadApplicationDetails(id) {
      hideMessage();
      try {
        const res = await fetch(`/api/applications/${id}`);
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          throw new Error(payload.error || 'Failed to load applicant details.');
        }

        selectedApplicationId = payload.item.id;
        detailsModal.classList.add('is-open');
        detailsModal.setAttribute('aria-hidden', 'false');
        detailsSubtitle.textContent = `Viewing applicant: ${payload.item.fullName} (Application #${payload.item.id})`;
        renderCompleteAnswers(payload.item);
        renderRequirementsCheckboxes(payload.item.credentialsSubmitted);
      } catch (err) {
        showMessage(err.message, 'danger');
      }
    }

    async function loadApplications() {
      const params = new URLSearchParams();
      if (statusFilter.value) params.set('status', statusFilter.value);
      if (strandFilter.value) params.set('strand', strandFilter.value);

      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Loading...</td></tr>';

      try {
        const res = await fetch(`/api/applications?${params.toString()}`);
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          throw new Error(payload.error || 'Failed to load applications.');
        }

        if (!payload.items.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No applications found.</td></tr>';
          return;
        }

        tbody.innerHTML = payload.items.map(item => `
          <tr>
            <td>${item.id}</td>
            <td><button type="button" class="name-link" data-view="details" data-id="${item.id}">${escapeHtml(item.fullName)}</button></td>
            <td>${escapeHtml(item.lrn)}</td>
            <td>${escapeHtml(item.strand || '-')}</td>
            <td>${statusChip(item.status)}</td>
            <td>${escapeHtml(item.submitted_at || '-')}</td>
            <td>${escapeHtml(item.credentialsSubmitted || '-')}</td>
            <td>${buildActionButtons(item)}</td>
          </tr>
        `).join('');
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">${escapeHtml(err.message)}</td></tr>`;
      }
    }

    tbody.addEventListener('click', (event) => {
      const viewButton = event.target.closest('button[data-view="details"]');
      if (viewButton) {
        const id = Number(viewButton.dataset.id);
        loadApplicationDetails(id);
        return;
      }

      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const id = Number(button.dataset.id);
      const action = button.dataset.action;
      updateStatus(id, action);
    });

    detailsApproveBtn.addEventListener('click', async () => {
      if (!selectedApplicationId) return;
      await updateStatus(selectedApplicationId, 'approved');
      await loadApplicationDetails(selectedApplicationId);
    });

    detailsRejectBtn.addEventListener('click', async () => {
      if (!selectedApplicationId) return;
      await updateStatus(selectedApplicationId, 'rejected');
      await loadApplicationDetails(selectedApplicationId);
    });

    detailsCloseBtn.addEventListener('click', closeDetailsModal);
    detailsModal.addEventListener('click', (event) => {
      if (event.target.matches('[data-close-modal="true"]')) {
        closeDetailsModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && detailsModal.classList.contains('is-open')) {
        closeDetailsModal();
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadApplications);
    statusFilter.addEventListener('change', loadApplications);
    strandFilter.addEventListener('change', loadApplications);

    loadApplications();
  </script>
</body>

</html>
