<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Admin - Application Approvals</title>

  <link href="../static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/assets/css/fontawesome.css">
  <link rel="stylesheet" href="../static/assets/css/templatemo-scholar.css">

  <style>
    body { font-family: "Poppins", sans-serif; }
    .admin-wrap { margin-top: 130px; margin-bottom: 60px; }
    .status-chip { font-size: 0.85rem; border-radius: 999px; padding: 4px 10px; }
    .status-submitted { background: #ffe8b3; color: #8a5c00; }
    .status-under_review { background: #d6edff; color: #0b5ed7; }
    .status-approved { background: #d1f3dd; color: #0f6b31; }
    .status-rejected { background: #ffd6db; color: #8b1d2c; }
    .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>

<body>
  <header class="header-area header-sticky background-header">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <nav class="main-nav">
            <a href="/" class="logo"><h1>Arellano University</h1></a>
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li><a href="/enroll">Online Application</a></li>
              <li class="nav-item dropdown scroll-to-section">
                <a class="nav-link dropdown-toggle admissions-link active" href="/admin" id="admissionsDropdown"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Admin
                </a>

                <div class="dropdown-menu admissions-menu" aria-labelledby="admissionsDropdown">
                  <form action="/admin/logout" method="post" style="margin:0;">
                    <button type="submit" class="dropdown-item" style="color:#fff; text-decoration:none;">Logout</button>
                  </form>
                </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <main class="container admin-wrap">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap" style="gap: 12px;">
      <div>
        <h3 class="mb-1">Application Approval Dashboard</h3>
        <p class="mb-0 text-muted">Review submitted applications and approve or reject them.</p>
      </div>
      <div class="d-flex" style="gap: 10px;">
        <select id="statusFilter" class="form-control">
          <option value="">All statuses</option>
          <option value="submitted">Submitted</option>
          <option value="under_review">Under review</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <select id="strandFilter" class="form-control">
          <option value="">All strands</option>
          <option value="STEM">STEM</option>
          <option value="ABM">ABM</option>
          <option value="HUMSS">HUMSS</option>
          <option value="GAS">GAS</option>
          <option value="TVL">TVL</option>
          <option value="ICT">ICT</option>
          <option value="HE">HE</option>
        </select>
        <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      </div>
    </div>

    <div class="alert alert-info d-none" id="messageBox" role="alert"></div>

    <div class="table-responsive bg-white rounded shadow-sm p-2">
      <table class="table table-striped table-hover mb-0" id="applicationsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Student</th>
            <th>LRN</th>
            <th>Strand</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const tbody = document.querySelector('#applicationsTable tbody');
    const messageBox = document.getElementById('messageBox');
    const statusFilter = document.getElementById('statusFilter');
    const strandFilter = document.getElementById('strandFilter');

    function showMessage(text, level = 'info') {
      messageBox.textContent = text;
      messageBox.className = `alert alert-${level}`;
      messageBox.classList.remove('d-none');
    }

    function hideMessage() {
      messageBox.classList.add('d-none');
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function statusChip(status) {
      const safe = escapeHtml(status || 'submitted');
      return `<span class="status-chip status-${safe}">${safe.replace('_', ' ')}</span>`;
    }

    async function updateStatus(id, status) {
      hideMessage();
      try {
        const res = await fetch(`/api/applications/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          throw new Error(payload.error || 'Failed to update status.');
        }
        showMessage(`Application #${id} updated to ${status}.`, 'success');
        await loadApplications();
      } catch (err) {
        showMessage(err.message, 'danger');
      }
    }

    function buildActionButtons(item) {
      const buttons = [];
      if (item.status !== 'under_review') {
        buttons.push(`<button class="btn btn-sm btn-outline-primary" data-action="under_review" data-id="${item.id}">Mark Under Review</button>`);
      }
      if (item.status !== 'approved') {
        buttons.push(`<button class="btn btn-sm btn-success" data-action="approved" data-id="${item.id}">Approve</button>`);
      }
      if (item.status !== 'rejected') {
        buttons.push(`<button class="btn btn-sm btn-danger" data-action="rejected" data-id="${item.id}">Reject</button>`);
      }
      return `<div class="action-btns">${buttons.join('')}</div>`;
    }

    async function loadApplications() {
      const params = new URLSearchParams();
      if (statusFilter.value) params.set('status', statusFilter.value);
      if (strandFilter.value) params.set('strand', strandFilter.value);

      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Loading...</td></tr>';

      try {
        const res = await fetch(`/api/applications?${params.toString()}`);
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          throw new Error(payload.error || 'Failed to load applications.');
        }

        if (!payload.items.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No applications found.</td></tr>';
          return;
        }

        tbody.innerHTML = payload.items.map(item => `
          <tr>
            <td>${item.id}</td>
            <td>${escapeHtml(item.fullName)}</td>
            <td>${escapeHtml(item.lrn)}</td>
            <td>${escapeHtml(item.strand || '-')}</td>
            <td>${statusChip(item.status)}</td>
            <td>${escapeHtml(item.submitted_at || '-')}</td>
            <td>${buildActionButtons(item)}</td>
          </tr>
        `).join('');
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">${escapeHtml(err.message)}</td></tr>`;
      }
    }

    tbody.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const id = Number(button.dataset.id);
      const action = button.dataset.action;
      updateStatus(id, action);
    });

    document.getElementById('refreshBtn').addEventListener('click', loadApplications);
    statusFilter.addEventListener('change', loadApplications);
    strandFilter.addEventListener('change', loadApplications);

    loadApplications();
  </script>
</body>

</html>
